---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Submit Module - KernelSU Modules">
    <div class="max-w-xl mx-auto px-4 sm:px-6 lg:px-8 py-12 min-h-[calc(100vh-200px)] flex items-center">
        <div class="w-full bg-white dark:bg-slate-900/50 rounded-2xl border border-gray-200 dark:border-slate-800 shadow-xl p-8 backdrop-blur-sm">
            <div class="mb-8 text-center">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-slate-100 mb-2 tracking-tight">Submit Your KernelSU Modules!</h1>
            </div>

            <form id="submission-form" class="space-y-5">
                <div class="flex flex-wrap items-end gap-2">
                    <span class="text-sm text-gray-700 dark:text-slate-300 py-2">I'd like to</span>
                    <select id="submission-type" name="type" class="flex-1 min-w-[200px] rounded-lg border border-gray-300 dark:border-slate-700 bg-white dark:bg-slate-950 text-gray-900 dark:text-slate-200 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-2 px-3">
                        <option value="submission">Submit a new module</option>
                        <option value="transfer">Transfer module ownership</option>
                        <option value="appeal">Appeal for module name/ownership</option>
                        <option value="issue">Report an issue</option>
                        <option value="suggestion">Give some suggestions</option>
                    </select>
                </div>

                <div id="module-id-group" class="flex flex-wrap items-end gap-2">
                    <span class="text-sm text-gray-700 dark:text-slate-300 py-2">Module ID:</span>
                    <div class="flex-1 min-w-[200px]">
                        <input type="text" id="module-id" name="id" placeholder="example-module-id" class="w-full rounded-lg border border-gray-300 dark:border-slate-700 bg-white dark:bg-slate-950 text-gray-900 dark:text-slate-200 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-2 px-3 placeholder:text-gray-400 dark:placeholder:text-slate-600" />
                        <p id="module-id-error" class="mt-1 text-xs text-red-500 hidden">Invalid module ID</p>
                    </div>
                </div>

                <div id="title-group" class="hidden flex-wrap items-end gap-2">
                    <span class="text-sm text-gray-700 dark:text-slate-300 py-2">Title:</span>
                    <input type="text" id="title-input" name="title" placeholder="Title" class="flex-1 min-w-[200px] rounded-lg border border-gray-300 dark:border-slate-700 bg-white dark:bg-slate-950 text-gray-900 dark:text-slate-200 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-2 px-3 placeholder:text-gray-400 dark:placeholder:text-slate-600" />
                </div>

                <div class="flex flex-wrap items-end gap-2">
                    <span class="text-sm text-gray-700 dark:text-slate-300 py-2">Description (Reason):</span>
                    <textarea id="description" name="description" rows="3" placeholder="Describe it" class="flex-1 min-w-[200px] rounded-lg border border-gray-300 dark:border-slate-700 bg-white dark:bg-slate-950 text-gray-900 dark:text-slate-200 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-2 px-3 placeholder:text-gray-400 dark:placeholder:text-slate-600"></textarea>
                </div>

                <div class="flex justify-center pt-4">
                    <button type="submit" id="submit-btn" disabled class="px-8 py-2.5 rounded-lg text-sm font-bold text-white bg-violet-600 hover:bg-violet-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-violet-500/20">
                        Submit
                    </button>
                </div>
            </form>
        </div>
    </div>
</Layout>

<script>
    const form = document.getElementById('submission-form');
    const typeSelect = document.getElementById('submission-type') as HTMLSelectElement;
    const moduleIdGroup = document.getElementById('module-id-group');
    const titleGroup = document.getElementById('title-group');
    const moduleIdInput = document.getElementById('module-id') as HTMLInputElement;
    const moduleIdError = document.getElementById('module-id-error');
    const titleInput = document.getElementById('title-input') as HTMLInputElement;
    const descriptionInput = document.getElementById('description') as HTMLTextAreaElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

    // Types that require module ID
    const moduleIdTypes = ['submission', 'transfer', 'appeal'];

    const showModuleId = () => moduleIdTypes.includes(typeSelect.value);

    const isPackageNameValid = () => /^[a-zA-Z][a-zA-Z0-9._-]*$/.test(moduleIdInput.value.trim());

    const updateFormVisibility = () => {
        if (showModuleId()) {
            moduleIdGroup?.classList.remove('hidden');
            moduleIdGroup?.classList.add('flex');
            titleGroup?.classList.add('hidden');
            titleGroup?.classList.remove('flex');
        } else {
            moduleIdGroup?.classList.add('hidden');
            moduleIdGroup?.classList.remove('flex');
            titleGroup?.classList.remove('hidden');
            titleGroup?.classList.add('flex');
        }
        validateForm();
    };

    const validateForm = () => {
        const moduleId = moduleIdInput.value.trim();
        const title = titleInput.value.trim();

        if (showModuleId()) {
            const valid = moduleId && isPackageNameValid();
            submitBtn.disabled = !valid;
            if (moduleId && !isPackageNameValid()) {
                moduleIdError?.classList.remove('hidden');
            } else {
                moduleIdError?.classList.add('hidden');
            }
        } else {
            submitBtn.disabled = !title;
        }
    };

    // Initialize from URL params
    const urlParams = new URLSearchParams(window.location.search);
    const initialType = urlParams.get('type');
    if (initialType && ['submission', 'transfer', 'appeal', 'issue', 'suggestion'].includes(initialType)) {
        typeSelect.value = initialType;
    }

    typeSelect?.addEventListener('change', () => {
        history.pushState({}, '', `?type=${typeSelect.value}`);
        updateFormVisibility();
    });

    moduleIdInput?.addEventListener('input', validateForm);
    titleInput?.addEventListener('input', validateForm);

    form?.addEventListener('submit', (e) => {
        e.preventDefault();
        const type = typeSelect.value;
        const issueTitle = showModuleId()
            ? `[${type}] ${moduleIdInput.value.trim()}`
            : `[${type}] ${titleInput.value.trim()}`;

        const url = `https://github.com/KernelSU-Modules-Repo/submission/issues/new?title=${
            encodeURIComponent(issueTitle)
        }&body=${
            encodeURIComponent(descriptionInput.value)
        }`;

        window.open(url, '_blank');
    });

    updateFormVisibility();
</script>
